<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ß–∞—Ç –Ω–∞ WebSocket</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
    #chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; }
    .msg { margin: 3px 0; }
    .system { margin: 3px 0; color: #555; font-style: italic; }
    #messageInput { width: 75%; padding: 8px; }
    #sendBtn { padding: 8px 12px; }
  </style>
</head>
<body>
  <h2>–ß–∞—Ç –Ω–∞ WebSocket</h2>
  <div id="chat"></div>
  <input id="messageInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è" />
  <button id="sendBtn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>

  <script>

  const originalTitle = "–ß–∞—Ç –Ω–∞ WebSocket";
  let socket;

  function addSystem(text) {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'system';
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function addMessage(from, text) {
    const chat = document.getElementById('chat');
    const div = document.createElement('div');
    div.className = 'msg';
    div.textContent = from + ': ' + text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function connect() {
    socket = new WebSocket('ws://localhost:3000');

    socket.onopen = () => {
      addSystem('–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —Å–µ—Ä–≤–µ—Ä–∞');
    };

    socket.onmessage = (event) => {
      let data;
      try {
        data = JSON.parse(event.data);
      } catch (e) {
        data = { type: 'chat', from: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', text: event.data };
      }

      if (data.type === 'system') {
        addSystem(data.text);
      } else if (data.type === 'chat') {
        addMessage(data.from || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á', data.text);
      }

      // —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏
      if (document.hidden && data.type === 'chat') {
        document.title = "üì© –ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ!";
        console.log("–°–ü–û–í–Ü–©–ï–ù–ù–Ø: –≤–∫–ª–∞–¥–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–∏–π—à–ª–æ –Ω–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è");
      }
    };

    socket.onclose = () => {
      addSystem('–ó‚Äô—î–¥–Ω–∞–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–æ, –ø—Ä–æ–±—É—î–º–æ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è...');
      setTimeout(connect, 2000);
    };

    socket.onerror = (err) => {
      console.error('–ü–æ–º–∏–ª–∫–∞ WebSocket:', err);
      addSystem('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ WebSocket');
    };
  }

  function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text) return;

    if (!socket || socket.readyState !== WebSocket.OPEN) {
      addSystem('–ù–µ–º–∞—î –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º');
      return;
    }

    socket.send(text);
    input.value = '';
  }

  document.getElementById('sendBtn').addEventListener('click', sendMessage);
  document.getElementById('messageInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      document.title = originalTitle;
    }
  });

  // —Å—Ç–∞—Ä—Ç–æ–≤–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
  connect();

  </script>
</body>
</html>
